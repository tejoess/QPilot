<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PaperCraft Studio</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400;1,600&family=JetBrains+Mono:wght@300;400;500&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* â”€â”€â”€ DESIGN TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root {
  --bg:         #f8f9fc;
  --bg2:        #f0f2f7;
  --surface:    #ffffff;
  --panel:      #fafbfd;
  --border:     #e5e7ef;
  --border2:    #d4d7e0;
  --shadow:     rgba(100, 110, 140, 0.08);
  --shadow-md:  rgba(100, 110, 140, 0.12);
  --shadow-lg:  rgba(100, 110, 140, 0.18);

  --ink:        #2d3748;
  --ink-mid:    #4a5568;
  --ink-soft:   #718096;
  --ink-dim:    #a0aec0;
  --ink-faint:  #cbd5e0;

  --accent:     #667eea;
  --accent-lt:  #eef2ff;
  --accent-mid: #7c93f5;
  --green:      #48bb78;
  --green-lt:   #e6f9f0;
  --blue:       #4299e1;
  --blue-lt:    #ebf8ff;

  --sidebar-w: 288px;
  --radius:    10px;
  --radius-sm: 6px;
  --ease:      cubic-bezier(0.4, 0, 0.2, 1);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  background: var(--bg);
  color: var(--ink);
  font-family: 'JetBrains Mono', monospace;
  font-size: 12.5px;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0; pointer-events: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.015'/%3E%3C/svg%3E");
}

#app {
  display: flex;
  height: 100vh; width: 100vw;
  overflow: hidden;
  position: relative; z-index: 1;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sidebar {
  width: var(--sidebar-w);
  min-width: var(--sidebar-w);
  height: 100%;
  background: var(--surface);
  border-right: 1.5px solid var(--border);
  display: flex; flex-direction: column;
  overflow: hidden;
  position: relative; z-index: 10;
  box-shadow: 4px 0 28px var(--shadow);
}
#sidebar::before {
  content: '';
  position: absolute; top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, #667eea, #7c93f5, #a5b4fc);
  z-index: 1;
}

.sb-header {
  padding: 22px 20px 16px;
  border-bottom: 1.5px solid var(--border);
  flex-shrink: 0;
}
.sb-logo { display: flex; align-items: center; gap: 10px; margin-bottom: 4px; }
.sb-logo-icon {
  width: 34px; height: 34px;
  background: linear-gradient(135deg, #667eea 0%, #7c93f5 100%);
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; position: relative; overflow: hidden;
}
.sb-logo-icon::after {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 55%);
}
.sb-logo-name {
  font-family: 'Outfit', sans-serif;
  font-size: 16px; font-weight: 700;
  color: var(--ink); letter-spacing: -0.4px;
}
.sb-logo-name em { font-style: normal; color: var(--accent); }
.sb-tagline {
  font-size: 9.5px; color: var(--ink-dim);
  letter-spacing: 0.8px; text-transform: uppercase;
  margin-left: 44px;
}

.stage-pills {
  display: flex; gap: 5px;
  padding: 13px 20px 0; flex-shrink: 0;
}
.stage-pill {
  flex: 1; height: 3px; border-radius: 99px;
  background: var(--border);
  transition: background 0.4s var(--ease);
  position: relative; overflow: hidden;
}
.stage-pill.active { background: var(--accent); }
.stage-pill.active::after {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.55), transparent);
  animation: shimmer 1.8s ease-in-out infinite;
}
@keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
.stage-pill.done { background: var(--green); }

.sb-body {
  flex: 1; overflow-y: auto;
  padding: 10px 0 12px;
  scrollbar-width: thin;
  scrollbar-color: var(--border2) transparent;
}
.sb-body::-webkit-scrollbar { width: 3px; }
.sb-body::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }

.sb-section { padding: 0 20px 14px; border-bottom: 1.5px solid var(--border); }
.sb-section:last-child { border-bottom: none; }
.sb-section-title {
  font-size: 9px; font-weight: 500;
  letter-spacing: 1.8px; text-transform: uppercase;
  color: var(--ink-dim); margin-bottom: 11px; padding-top: 13px;
  display: flex; align-items: center; gap: 7px;
}
.sb-section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

.form-group { margin-bottom: 11px; }
.form-label { display: block; font-size: 10px; color: var(--ink-soft); margin-bottom: 5px; }
.form-input, .form-select {
  width: 100%; height: 33px;
  background: var(--panel);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--ink);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11.5px; padding: 0 10px; outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  appearance: none;
}
.form-input:focus, .form-select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(192,98,42,0.1);
}
.form-select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23a89f92' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center;
  padding-right: 28px; cursor: pointer;
}

.form-range-wrap { display: flex; align-items: center; gap: 8px; }
.form-range {
  flex: 1; -webkit-appearance: none;
  height: 3px; background: var(--border2);
  border-radius: 99px; outline: none; cursor: pointer;
}
.form-range::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 15px; height: 15px;
  border-radius: 50%; background: var(--accent);
  cursor: pointer; transition: transform 0.15s;
  box-shadow: 0 1px 4px rgba(102, 126, 234, 0.3);
}
.form-range::-webkit-slider-thumb:hover { transform: scale(1.25); }
.range-val { font-size: 11px; color: var(--accent); min-width: 28px; text-align: right; font-weight: 500; }

.toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 9px; }
.toggle-label { font-size: 11px; color: var(--ink-soft); }
.toggle { position: relative; width: 34px; height: 18px; cursor: pointer; }
.toggle input { display: none; }
.toggle-track { position: absolute; inset: 0; background: var(--border2); border-radius: 99px; transition: background 0.25s; }
.toggle input:checked ~ .toggle-track { background: var(--green); }
.toggle-thumb {
  position: absolute; top: 3px; left: 3px;
  width: 12px; height: 12px;
  background: #fff; border-radius: 50%;
  transition: transform 0.25s var(--ease);
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
.toggle input:checked ~ .toggle-track + .toggle-thumb { transform: translateX(16px); }

.color-swatches { display: flex; gap: 7px; flex-wrap: wrap; }
.swatch {
  width: 23px; height: 23px; border-radius: 5px;
  cursor: pointer; border: 2.5px solid transparent;
  transition: transform 0.15s, border-color 0.15s;
}
.swatch:hover { transform: scale(1.15); }
.swatch.selected { border-color: var(--ink); transform: scale(1.05); }

.sb-footer {
  padding: 12px 20px 20px; flex-shrink: 0;
  border-top: 1.5px solid var(--border);
  background: var(--panel);
}
.stage-label {
  font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase;
  color: var(--ink-dim); text-align: center; margin-bottom: 9px;
}
.stage-label span { color: var(--accent); font-weight: 500; }

.btn {
  display: inline-flex; align-items: center; justify-content: center;
  gap: 6px; border: none; border-radius: var(--radius-sm);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11.5px; font-weight: 500; cursor: pointer;
  transition: all 0.2s; white-space: nowrap;
}
.btn-primary {
  width: 100%; height: 38px;
  background: linear-gradient(135deg, var(--accent) 0%, var(--accent-mid) 100%);
  color: #fff; letter-spacing: 0.3px;
}
.btn-primary:hover { 
  background: linear-gradient(135deg, #7c93f5 0%, #8da4f8 100%);
  box-shadow: 0 4px 16px rgba(102, 126, 234, 0.25); 
  transform: translateY(-1px); 
}
.btn-ghost {
  width: 100%; height: 36px; margin-top: 7px;
  background: transparent; color: var(--ink-soft);
  border: 1.5px solid var(--border);
}
.btn-ghost:hover { border-color: var(--border2); color: var(--ink); background: var(--bg2); }
.btn-outline-accent {
  background: transparent; color: var(--accent);
  border: 1.5px solid rgba(192,98,42,0.3);
  height: 30px; padding: 0 12px; font-size: 11px;
}
.btn-outline-accent:hover { background: var(--accent-lt); border-color: var(--accent); }
.btn-sm { height: 30px; padding: 0 12px; font-size: 11px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#main { flex: 1; height: 100%; overflow: hidden; position: relative; background: var(--bg); }

.stage-view {
  position: absolute; inset: 0;
  opacity: 0; pointer-events: none;
  transition: opacity 0.42s var(--ease), transform 0.42s var(--ease);
  transform: translateX(28px);
  overflow-y: auto;
  scrollbar-width: thin;
  scrollbar-color: var(--border2) transparent;
}
.stage-view::-webkit-scrollbar { width: 4px; }
.stage-view::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 4px; }
.stage-view.active { opacity: 1; pointer-events: all; transform: translateX(0); }
.stage-view.exit { opacity: 0; transform: translateX(-28px); pointer-events: none; }

.main-topbar {
  height: 54px; border-bottom: 1.5px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 28px;
  background: rgba(255,255,255,0.88);
  backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
  position: sticky; top: 0; z-index: 5;
}
.topbar-title { font-family: 'Playfair Display', serif; font-size: 17px; color: var(--ink); }
.topbar-title em { font-style: italic; color: var(--accent); }
.topbar-meta { display: flex; align-items: center; gap: 8px; }

.badge {
  font-size: 9.5px; padding: 3px 9px; border-radius: 99px;
  font-family: 'JetBrains Mono', monospace;
  letter-spacing: 0.5px; text-transform: uppercase;
}
.badge-neutral { background: var(--bg2); color: var(--ink-soft); border: 1px solid var(--border); }
.badge-amber   { background: #fef3c7; color: #d97706; border: 1px solid #fde68a; }
.badge-green   { background: var(--green-lt); color: var(--green); border: 1px solid rgba(72,187,120,0.2); }

/* â”€â”€â”€ STAGE 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.builder-content { padding: 24px 28px 48px; }

.canvas-wrap {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  min-height: 340px;
  position: relative; overflow: hidden;
  margin-bottom: 20px;
  cursor: crosshair;
  box-shadow: 0 2px 16px var(--shadow), inset 0 1px 0 rgba(255,255,255,0.8);
  transition: box-shadow 0.25s;
}
.canvas-wrap:hover { box-shadow: 0 8px 32px var(--shadow-md), inset 0 1px 0 rgba(255,255,255,0.8); }

.canvas-grid {
  position: absolute; inset: 0;
  background-image:
    linear-gradient(var(--border) 1px, transparent 1px),
    linear-gradient(90deg, var(--border) 1px, transparent 1px);
  background-size: 30px 30px;
  opacity: 0.65;
}
.canvas-center {
  position: absolute; inset: 0;
  display: flex; align-items: center; justify-content: center;
  flex-direction: column; gap: 14px;
}
.canvas-placeholder-icon {
  width: 68px; height: 68px;
  border: 2px dashed var(--ink-faint);
  border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  color: var(--ink-faint);
  animation: float 3.2s ease-in-out infinite;
}
@keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
.canvas-placeholder-text { font-size: 11.5px; color: var(--ink-dim); text-align: center; line-height: 1.7; }
.canvas-placeholder-text strong { color: var(--accent); }

.pattern-grid {
  position: absolute; inset: 18px;
  display: grid;
  grid-template-columns: repeat(var(--cols,4), 1fr);
  grid-template-rows: repeat(var(--rows,3), 1fr);
  gap: 8px;
  opacity: 0; transition: opacity 0.4s;
}
.pattern-grid.visible { opacity: 1; }

.pattern-cell {
  border-radius: 6px;
  border: 1.5px solid var(--border);
  background: var(--panel);
  display: flex; align-items: center; justify-content: center;
  font-size: 9px; color: var(--ink-dim);
  cursor: pointer; transition: all 0.2s;
  animation: cellIn 0.35s var(--ease) backwards;
  position: relative; overflow: hidden;
}
.pattern-cell::before {
  content: '';
  position: absolute; inset: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.65) 0%, transparent 55%);
  pointer-events: none;
}
.pattern-cell:hover {
  border-color: var(--accent);
  box-shadow: 0 2px 10px rgba(192,98,42,0.13);
  transform: scale(1.03);
}
.pattern-cell.active-cell { border-color: var(--green); box-shadow: 0 2px 10px rgba(58,125,90,0.15); }
@keyframes cellIn { from { opacity:0; transform: scale(0.8); } to { opacity:1; transform: scale(1); } }

.config-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 18px; }
.config-panel {
  background: var(--surface); border: 1.5px solid var(--border);
  border-radius: var(--radius); padding: 15px 17px;
  box-shadow: 0 1px 6px var(--shadow);
}
.config-panel-title {
  font-size: 9px; letter-spacing: 1.8px; text-transform: uppercase;
  color: var(--ink-dim); margin-bottom: 11px;
  display: flex; align-items: center; gap: 6px;
}
.dot-a { width: 5px; height: 5px; border-radius: 50%; background: var(--accent); flex-shrink:0; }
.dot-g { width: 5px; height: 5px; border-radius: 50%; background: var(--green);  flex-shrink:0; }
.dot-b { width: 5px; height: 5px; border-radius: 50%; background: var(--blue);   flex-shrink:0; }

.tag-pills { display: flex; flex-wrap: wrap; gap: 5px; }
.tag-pill {
  font-size: 10px; padding: 4px 10px;
  border-radius: 99px; border: 1.5px solid var(--border);
  color: var(--ink-soft); cursor: pointer;
  transition: all 0.18s; background: transparent;
  font-family: 'JetBrains Mono', monospace;
}
.tag-pill:hover { border-color: var(--border2); color: var(--ink); background: var(--bg2); }
.tag-pill.active { border-color: var(--accent); color: var(--accent); background: var(--accent-lt); font-weight: 500; }

.action-row {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 22px; padding-top: 22px;
  border-top: 1.5px solid var(--border);
}
.action-info { font-size: 11px; color: var(--ink-dim); line-height: 1.6; }
.action-info strong { color: var(--ink-soft); }

.btn-process {
  background: var(--accent); color: #fff;
  height: 44px; padding: 0 26px;
  font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 600;
  border: none; border-radius: var(--radius-sm);
  cursor: pointer; display: flex; align-items: center; gap: 8px;
  transition: all 0.25s; position: relative; overflow: hidden;
  box-shadow: 0 4px 14px rgba(102, 126, 234, 0.3);
}
.btn-process::after {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.22), transparent);
  transform: translateX(-100%);
}
.btn-process:hover {
  background: #7c93f5;
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(102, 126, 234, 0.38);
}
.btn-process:hover::after { animation: swipe 0.5s forwards; }
@keyframes swipe { to { transform: translateX(100%); } }
.btn-process:active { transform: translateY(0); }

/* â”€â”€â”€ STAGE 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.processing-content { padding: 40px 44px; }
.processing-header { text-align: center; margin-bottom: 44px; }

.processing-icon-wrap {
  width: 76px; height: 76px; margin: 0 auto 20px;
  position: relative; display: flex; align-items: center; justify-content: center;
}
.ring {
  position: absolute; inset: 0; border-radius: 50%;
  border: 2px solid transparent; border-top-color: var(--accent);
  animation: spin 1.3s linear infinite;
}
.ring-2 { inset: 9px; border-top-color: var(--green); animation-direction: reverse; animation-duration: 1.9s; }
.ring-3 { inset: 18px; border-top-color: var(--blue); animation-duration: 2.5s; }
@keyframes spin { to { transform: rotate(360deg); } }
.proc-core {
  width: 22px; height: 22px; background: var(--accent); border-radius: 5px;
  animation: corePulse 1.3s ease-in-out infinite; position: relative; z-index: 1;
}
@keyframes corePulse {
  0%, 100% { opacity:0.75; transform: scale(0.88) rotate(0deg); }
  50%       { opacity:1;   transform: scale(1.05) rotate(45deg); }
}
.processing-title { font-family: 'Playfair Display', serif; font-size: 26px; color: var(--ink); margin-bottom: 6px; }
.processing-subtitle { font-size: 11.5px; color: var(--ink-soft); }

.steps-list { max-width: 460px; margin: 0 auto 32px; }
.step-item {
  display: flex; align-items: flex-start; gap: 13px;
  padding: 12px 0; border-bottom: 1px solid var(--border);
  opacity: 0; transform: translateX(-10px);
  transition: opacity 0.35s, transform 0.35s;
}
.step-item.revealed { opacity: 1; transform: translateX(0); }
.step-item:last-child { border-bottom: none; }
.step-indicator {
  width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0;
  border: 1.5px solid var(--border2);
  display: flex; align-items: center; justify-content: center;
  font-size: 10px; color: var(--ink-dim);
  background: var(--panel); transition: all 0.35s;
}
.step-item.done    .step-indicator { border-color: var(--green); background: var(--green-lt); color: var(--green); }
.step-item.running .step-indicator { border-color: var(--accent); background: var(--accent-lt); color: var(--accent); animation: stepRing 1s ease-in-out infinite; }
@keyframes stepRing {
  0%, 100% { box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.25); }
  50%       { box-shadow: 0 0 0 6px rgba(102, 126, 234, 0); }
}
.step-info { flex: 1; }
.step-name { font-size: 12px; color: var(--ink); margin-bottom: 2px; }
.step-desc { font-size: 10px; color: var(--ink-soft); }
.step-time { font-size: 10px; color: var(--ink-dim); }

.progress-wrap { max-width: 460px; margin: 0 auto 28px; }
.progress-head { display: flex; justify-content: space-between; margin-bottom: 7px; font-size: 10px; color: var(--ink-dim); }
.progress-track { height: 5px; background: var(--border); border-radius: 99px; overflow: hidden; }
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--green), var(--accent));
  border-radius: 99px;
  transition: width 0.85s var(--ease);
  box-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
}

.log-terminal {
  max-width: 460px; margin: 0 auto;
  background: #1e1b16; border-radius: var(--radius);
  padding: 14px 16px; max-height: 170px; overflow-y: auto;
  scrollbar-width: thin; scrollbar-color: #3a3730 transparent;
  box-shadow: 0 4px 24px var(--shadow-lg);
}
.log-terminal::-webkit-scrollbar { width: 3px; }
.log-terminal::-webkit-scrollbar-thumb { background: #3a3730; border-radius: 3px; }
.log-header {
  display: flex; align-items: center; gap: 5px;
  margin-bottom: 11px; font-size: 9px;
  letter-spacing: 1.5px; text-transform: uppercase; color: #5a5550;
}
.log-dot { width: 8px; height: 8px; border-radius: 50%; }
.log-entry { font-size: 10px; padding: 2.5px 0; color: #9a9288; line-height: 1.6; opacity: 0; animation: logIn 0.3s forwards; }
@keyframes logIn { to { opacity:1; } }
.lt { color: #5a5550; margin-right: 8px; }
.li { color: #7cb8e8; margin-right: 6px; }
.lw { color: #e8c87c; margin-right: 6px; }
.lo { color: #7ce8a8; margin-right: 6px; }

/* â”€â”€â”€ STAGE 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.output-content { padding: 28px 36px 56px; }
.output-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 22px; }
.output-title { font-family: 'Playfair Display', serif; font-size: 22px; color: var(--ink); }
.output-title em { font-style: italic; color: var(--accent); }
.output-actions { display: flex; gap: 8px; }

.paper-preview {
  background: #fffdf8;
  border-radius: var(--radius); overflow: hidden;
  border: 1.5px solid var(--border);
  box-shadow: 0 8px 40px var(--shadow-lg), 0 2px 8px var(--shadow);
  animation: paperReveal 0.65s var(--ease) backwards;
  position: relative;
}
@keyframes paperReveal { from { opacity:0; transform: scale(0.97) translateY(14px); } to { opacity:1; transform: scale(1) translateY(0); } }
.paper-preview::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0;
  height: 3px;
  background: linear-gradient(90deg, #667eea, #7c93f5, #a5b4fc);
}

.paper-inner { padding: 52px 60px 48px; color: var(--ink); position: relative; }
.paper-watermark {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%) rotate(-22deg);
  font-family: 'Outfit', sans-serif; font-size: 88px; font-weight: 800;
  color: rgba(28,26,22,0.028); white-space: nowrap;
  pointer-events: none; letter-spacing: -2px; user-select: none; display: none;
}
.paper-header-line {
  display: flex; align-items: flex-start; justify-content: space-between;
  margin-bottom: 36px; padding-bottom: 26px;
  border-bottom: 1.5px solid rgba(28,26,22,0.12);
}
.paper-doc-title { font-family: 'Playfair Display', serif; font-size: 26px; color: var(--ink); line-height: 1.25; max-width: 420px; }
.paper-doc-title span { display: block; }
.paper-doc-title em { font-style: italic; color: var(--accent); font-size: 20px; }
.paper-meta-block { text-align: right; }
.paper-meta-item { font-family: 'JetBrains Mono', monospace; font-size: 10px; color: rgba(28,26,22,0.5); margin-bottom: 4px; }
.paper-meta-item strong { color: rgba(28,26,22,0.75); }
.paper-abstract-label { font-family: 'JetBrains Mono', monospace; font-size: 8.5px; letter-spacing: 2px; text-transform: uppercase; color: rgba(28,26,22,0.35); margin-bottom: 10px; }
.paper-abstract { font-family: 'Playfair Display', serif; font-style: italic; font-size: 13.5px; line-height: 1.85; color: rgba(28,26,22,0.7); margin-bottom: 30px; }
.paper-section { margin-bottom: 26px; }
.paper-section-title { font-family: 'JetBrains Mono', monospace; font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: rgba(28,26,22,0.35); margin-bottom: 9px; padding-left: 12px; border-left: 2px solid var(--accent); }
.paper-section-body { font-family: 'JetBrains Mono', monospace; font-size: 11px; line-height: 1.85; color: rgba(28,26,22,0.65); }

.paper-pattern-visual { display: grid; grid-template-columns: repeat(4,1fr); gap: 6px; margin: 18px 0; }
.paper-pattern-cell {
  height: 46px; border-radius: 5px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'JetBrains Mono', monospace; font-size: 9px;
  border: 1px solid rgba(28,26,22,0.1);
  animation: cellReveal 0.45s var(--ease) backwards;
}
@keyframes cellReveal { from { opacity:0; transform: scale(0.82); } to { opacity:1; transform: scale(1); } }

.export-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 22px; }
.export-card {
  background: var(--surface); border: 1.5px solid var(--border);
  border-radius: var(--radius); padding: 15px 16px;
  cursor: pointer; transition: all 0.22s;
  display: flex; flex-direction: column; gap: 7px;
  box-shadow: 0 1px 6px var(--shadow);
}
.export-card:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 8px 24px var(--shadow-md); }
.export-icon { width: 34px; height: 34px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
.export-name { font-size: 12px; color: var(--ink); font-weight: 500; font-family: 'Outfit', sans-serif; }
.export-desc { font-size: 10px; color: var(--ink-dim); }

.restart-row { display: flex; justify-content: center; margin-top: 28px; }
.btn-restart {
  background: transparent; color: var(--ink-soft);
  border: 1.5px dashed var(--border2); height: 36px;
  padding: 0 20px; border-radius: var(--radius-sm);
  font-family: 'JetBrains Mono', monospace; font-size: 11px;
  cursor: pointer; display: flex; align-items: center; gap: 7px;
  transition: all 0.2s;
}
.btn-restart:hover { color: var(--ink); border-color: var(--ink-dim); background: var(--bg2); }

@keyframes slideUp { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
.animate-in { animation: slideUp 0.4s var(--ease) backwards; }

@media (max-width: 720px) {
  .config-row { grid-template-columns: 1fr; }
  .export-row { grid-template-columns: 1fr; }
  :root { --sidebar-w: 256px; }
}
</style>
</head>

<body>
<div id="app">

  <!-- â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â• -->
  <aside id="sidebar">
    <div class="sb-header">
      <div class="sb-logo">
        <div class="sb-logo-icon">
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
            <rect x="2"  y="2"  width="6" height="6" rx="1.5" fill="#fff"/>
            <rect x="10" y="2"  width="6" height="6" rx="1.5" fill="#fff" opacity=".6"/>
            <rect x="2"  y="10" width="6" height="6" rx="1.5" fill="#fff" opacity=".6"/>
            <rect x="10" y="10" width="6" height="6" rx="1.5" fill="#fff" opacity=".3"/>
          </svg>
        </div>
        <span class="sb-logo-name">Paper<em>Craft</em></span>
      </div>
      <div class="sb-tagline">Pattern Design Studio</div>
    </div>

    <div class="stage-pills">
      <div class="stage-pill active" id="pill-1"></div>
      <div class="stage-pill"        id="pill-2"></div>
      <div class="stage-pill"        id="pill-3"></div>
    </div>

    <div class="sb-body">

      <div class="sb-section">
        <div class="sb-section-title">Document</div>
        <div class="form-group">
          <label class="form-label">Title</label>
          <input class="form-input" type="text" id="doc-title" value="Geometric Pattern Study">
        </div>
        <div class="form-group">
          <label class="form-label">Paper Size</label>
          <select class="form-select">
            <option>A4 (210 Ã— 297 mm)</option>
            <option>Letter (8.5 Ã— 11 in)</option>
            <option>A3 (297 Ã— 420 mm)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Orientation</label>
          <select class="form-select">
            <option>Portrait</option>
            <option>Landscape</option>
          </select>
        </div>
      </div>

      <div class="sb-section">
        <div class="sb-section-title">Pattern</div>
        <div class="form-group">
          <label class="form-label">Grid Columns</label>
          <div class="form-range-wrap">
            <input class="form-range" type="range" min="1" max="8" value="4" id="range-cols"
              oninput="document.getElementById('val-cols').textContent=this.value; updatePattern();">
            <span class="range-val" id="val-cols">4</span>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Grid Rows</label>
          <div class="form-range-wrap">
            <input class="form-range" type="range" min="1" max="6" value="3" id="range-rows"
              oninput="document.getElementById('val-rows').textContent=this.value; updatePattern();">
            <span class="range-val" id="val-rows">3</span>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Cell Spacing</label>
          <div class="form-range-wrap">
            <input class="form-range" type="range" min="2" max="24" value="8" id="range-gap"
              oninput="document.getElementById('val-gap').textContent=this.value+'px';">
            <span class="range-val" id="val-gap">8px</span>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" style="margin-bottom:8px">Colour Palette</label>
          <div class="color-swatches">
            <div class="swatch selected" style="background:linear-gradient(135deg, #a78bfa 0%, #c4b5fd 100%)" data-color="purple" onclick="selectSwatch(this)"></div>
            <div class="swatch" style="background:linear-gradient(135deg, #60a5fa 0%, #93c5fd 100%)" data-color="sky" onclick="selectSwatch(this)"></div>
            <div class="swatch" style="background:linear-gradient(135deg, #34d399 0%, #6ee7b7 100%)" data-color="emerald" onclick="selectSwatch(this)"></div>
            <div class="swatch" style="background:linear-gradient(135deg, #f472b6 0%, #f9a8d4 100%)" data-color="pink" onclick="selectSwatch(this)"></div>
            <div class="swatch" style="background:linear-gradient(135deg, #fbbf24 0%, #fcd34d 100%)" data-color="amber" onclick="selectSwatch(this)"></div>
            <div class="swatch" style="background:linear-gradient(135deg, #fb923c 0%, #fdba74 100%)" data-color="orange" onclick="selectSwatch(this)"></div>
          </div>
        </div>
      </div>

      <div class="sb-section">
        <div class="sb-section-title">Layout</div>
        <div class="toggle-row">
          <span class="toggle-label">Show Grid Lines</span>
          <label class="toggle"><input type="checkbox" checked id="toggle-grid"><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Cell Labels</span>
          <label class="toggle"><input type="checkbox" id="toggle-labels"><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Auto Numbering</span>
          <label class="toggle"><input type="checkbox" checked id="toggle-num"><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Watermark</span>
          <label class="toggle"><input type="checkbox" id="toggle-watermark" onchange="toggleWM(this)"><div class="toggle-track"></div><div class="toggle-thumb"></div></label>
        </div>
        <div class="form-group" style="margin-top:10px">
          <label class="form-label">Export Format</label>
          <select class="form-select">
            <option>PDF (High Quality)</option>
            <option>PNG (300dpi)</option>
            <option>SVG (Vector)</option>
            <option>EPS (Print)</option>
          </select>
        </div>
      </div>

      <div class="sb-section">
        <div class="sb-section-title">Metadata</div>
        <div class="form-group">
          <label class="form-label">Author</label>
          <input class="form-input" type="text" value="Alex Morgan">
        </div>
        <div class="form-group">
          <label class="form-label">Keywords</label>
          <input class="form-input" type="text" value="geometry, patterns, design">
        </div>
        <div class="form-group">
          <label class="form-label">Version</label>
          <input class="form-input" type="text" value="1.0.0">
        </div>
      </div>

    </div>

    <div class="sb-footer">
      <div class="stage-label">Stage <span id="sn">1</span> â€” <span id="ss">Pattern Builder</span></div>
      <button class="btn btn-primary" onclick="resetToStage1()">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        Reset All
      </button>
      <button class="btn btn-ghost">
        <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        Help / Docs
      </button>
    </div>
  </aside>

  <!-- â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â• -->
  <main id="main">

    <!-- STAGE 1 -->
    <div class="stage-view active" id="stage-1">
      <div class="main-topbar">
        <div class="topbar-title"><em>Pattern</em> Builder</div>
        <div class="topbar-meta">
          <span class="badge badge-amber">Stage 1 of 3</span>
          <button class="btn-outline-accent" onclick="generatePattern()">
            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            Preview
          </button>
        </div>
      </div>
      <div class="builder-content">
        <div class="canvas-wrap">
          <div class="canvas-grid" id="canvas-grid"></div>
          <div class="canvas-center" id="canvas-empty">
            <div class="canvas-placeholder-icon">
              <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.4">
                <rect x="3" y="3" width="7" height="7" rx="1.5"/>
                <rect x="14" y="3" width="7" height="7" rx="1.5"/>
                <rect x="3" y="14" width="7" height="7" rx="1.5"/>
                <rect x="14" y="14" width="7" height="7" rx="1.5"/>
              </svg>
            </div>
            <div class="canvas-placeholder-text">Click <strong>Preview</strong> to render your pattern</div>
          </div>
          <div class="pattern-grid" id="pattern-grid" style="--cols:4;--rows:3"></div>
        </div>

        <div class="config-row">
          <div class="config-panel animate-in" style="animation-delay:.04s">
            <div class="config-panel-title"><span class="dot-a"></span> Pattern Type</div>
            <div class="tag-pills">
              <span class="tag-pill active" onclick="selectTag(this)">Geometric</span>
              <span class="tag-pill" onclick="selectTag(this)">Organic</span>
              <span class="tag-pill" onclick="selectTag(this)">Textile</span>
              <span class="tag-pill" onclick="selectTag(this)">Abstract</span>
              <span class="tag-pill" onclick="selectTag(this)">Botanical</span>
              <span class="tag-pill" onclick="selectTag(this)">Minimal</span>
            </div>
          </div>
          <div class="config-panel animate-in" style="animation-delay:.09s">
            <div class="config-panel-title"><span class="dot-g"></span> Density</div>
            <div class="tag-pills" style="margin-bottom:10px">
              <span class="tag-pill" onclick="selectTag(this)">Sparse</span>
              <span class="tag-pill active" onclick="selectTag(this)">Regular</span>
              <span class="tag-pill" onclick="selectTag(this)">Dense</span>
            </div>
            <div class="config-panel-title"><span class="dot-b"></span> Symmetry</div>
            <div class="tag-pills">
              <span class="tag-pill active" onclick="selectTag(this)">None</span>
              <span class="tag-pill" onclick="selectTag(this)">Mirror</span>
              <span class="tag-pill" onclick="selectTag(this)">Radial</span>
            </div>
          </div>
        </div>

        <div class="action-row animate-in" style="animation-delay:.13s">
          <div class="action-info">
            <strong id="cell-count">12 cells</strong> configured â€”<br>ready to generate paper pattern
          </div>
          <button class="btn-process" onclick="goToStage2()">
            Process Next
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
          </button>
        </div>
      </div>
    </div>

    <!-- STAGE 2 -->
    <div class="stage-view" id="stage-2">
      <div class="main-topbar">
        <div class="topbar-title"><em>Processing</em> Pipeline</div>
        <div class="topbar-meta">
          <span class="badge badge-amber" id="proc-badge">Running</span>
          <span class="badge badge-neutral">Stage 2 of 3</span>
        </div>
      </div>
      <div class="processing-content">
        <div class="processing-header">
          <div class="processing-icon-wrap">
            <div class="ring"></div>
            <div class="ring ring-2"></div>
            <div class="ring ring-3"></div>
            <div class="proc-core" id="proc-core"></div>
          </div>
          <div class="processing-title" id="proc-title">Generating Pattern</div>
          <div class="processing-subtitle" id="proc-sub">Initialising render pipelineâ€¦</div>
        </div>
        <div class="progress-wrap">
          <div class="progress-head">
            <span>Overall progress</span>
            <span id="prog-pct">0%</span>
          </div>
          <div class="progress-track">
            <div class="progress-fill" id="prog-fill" style="width:0%"></div>
          </div>
        </div>
        <div class="steps-list">
          <div class="step-item" id="step-0">
            <div class="step-indicator" id="si-0">1</div>
            <div class="step-info"><div class="step-name">Initialise workspace</div><div class="step-desc">Loading pattern config &amp; assets</div></div>
            <div class="step-time" id="st-0">â€”</div>
          </div>
          <div class="step-item" id="step-1">
            <div class="step-indicator" id="si-1">2</div>
            <div class="step-info"><div class="step-name">Build grid structure</div><div class="step-desc">Calculating cell dimensions &amp; spacing</div></div>
            <div class="step-time" id="st-1">â€”</div>
          </div>
          <div class="step-item" id="step-2">
            <div class="step-indicator" id="si-2">3</div>
            <div class="step-info"><div class="step-name">Apply pattern rules</div><div class="step-desc">Rendering geometric transformations</div></div>
            <div class="step-time" id="st-2">â€”</div>
          </div>
          <div class="step-item" id="step-3">
            <div class="step-indicator" id="si-3">4</div>
            <div class="step-info"><div class="step-name">Colour calibration</div><div class="step-desc">Applying palette &amp; contrast adjustments</div></div>
            <div class="step-time" id="st-3">â€”</div>
          </div>
          <div class="step-item" id="step-4">
            <div class="step-indicator" id="si-4">5</div>
            <div class="step-info"><div class="step-name">Compose final paper</div><div class="step-desc">Assembling layout, metadata &amp; export</div></div>
            <div class="step-time" id="st-4">â€”</div>
          </div>
        </div>
        <div class="log-terminal" id="log-terminal">
          <div class="log-header">
            <span class="log-dot" style="background:#e87c7c"></span>
            <span class="log-dot" style="background:#e8c87c"></span>
            <span class="log-dot" style="background:#7ce8a8"></span>
            <span style="margin-left:6px">system.log</span>
          </div>
        </div>
      </div>
    </div>

    <!-- STAGE 3 -->
    <div class="stage-view" id="stage-3">
      <div class="main-topbar">
        <div class="topbar-title"><em>Output</em> Ready</div>
        <div class="topbar-meta">
          <span class="badge badge-green">âœ“ Complete</span>
          <span class="badge badge-neutral">Stage 3 of 3</span>
        </div>
      </div>
      <div class="output-content">
        <div class="output-header">
          <div class="output-title">Generated <em>Paper</em></div>
          <div class="output-actions">
            <button class="btn btn-sm" style="background:var(--bg2);color:var(--ink-soft);border:1.5px solid var(--border);gap:5px">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              Preview
            </button>
            <button class="btn btn-sm" style="background:var(--green);color:#fff;gap:5px;border:none">
              <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              Download
            </button>
          </div>
        </div>

        <div class="paper-preview">
          <div class="paper-watermark" id="paper-watermark">PaperCraft</div>
          <div class="paper-inner">
            <div class="paper-header-line">
              <div class="paper-doc-title" id="paper-doc-title">
                <span>Geometric Pattern Study</span>
                <em>An exploration of grid-based design</em>
              </div>
              <div class="paper-meta-block">
                <div class="paper-meta-item"><strong>Author:</strong> Alex Morgan</div>
                <div class="paper-meta-item"><strong>Date:</strong> Feb 2026</div>
                <div class="paper-meta-item"><strong>Version:</strong> 1.0.0</div>
                <div class="paper-meta-item"><strong>Format:</strong> A4 Portrait</div>
              </div>
            </div>
            <div class="paper-abstract-label">Abstract</div>
            <div class="paper-abstract">
              This document presents a systematic study of geometric pattern generation using
              grid-based cell structures. The configuration employs a 4 Ã— 3 arrangement with
              purple gradient palette calibration and optimised spacing for print-ready output.
            </div>
            <div class="paper-pattern-visual" id="paper-pattern-visual"></div>
            <div class="paper-section">
              <div class="paper-section-title">01 â€” Configuration</div>
              <div class="paper-section-body" id="paper-cfg">Grid: 4 col Ã— 3 row Â· Spacing: 8px Â· Type: Geometric Â· Density: Regular Â· Symmetry: None Â· Palette: Purple Â· Watermark: Off</div>
            </div>
            <div class="paper-section">
              <div class="paper-section-title">02 â€” Pattern Analysis</div>
              <div class="paper-section-body">The selected pattern type exhibits a regular geometric distribution across the defined grid space. Cell intervals are uniformly distributed with a calculated aspect ratio of 1:0.75 per unit. Boundary conditions apply standard edge padding.</div>
            </div>
            <div class="paper-section">
              <div class="paper-section-title">03 â€” Export Manifest</div>
              <div class="paper-section-body">Primary: PDF (High Quality) Â· Colour space: sRGB Â· Resolution: 300 dpi Â· Bleed: 3 mm Â· Layers: Flattened Â· Estimated file size: ~1.2 MB</div>
            </div>
          </div>
        </div>

        <div class="export-row">
          <div class="export-card">
            <div class="export-icon" style="background:#eef2ff">ğŸ“„</div>
            <div class="export-name">PDF</div>
            <div class="export-desc">Print-ready, high quality</div>
          </div>
          <div class="export-card">
            <div class="export-icon" style="background:var(--green-lt)">ğŸ–¼</div>
            <div class="export-name">PNG / SVG</div>
            <div class="export-desc">Web &amp; screen formats</div>
          </div>
          <div class="export-card">
            <div class="export-icon" style="background:var(--blue-lt)">ğŸ“¦</div>
            <div class="export-name">Archive</div>
            <div class="export-desc">All formats bundled</div>
          </div>
        </div>

        <div class="restart-row">
          <button class="btn-restart" onclick="resetToStage1()">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            Create New Pattern
          </button>
        </div>
      </div>
    </div>

  </main>
</div>

<script>
/* â”€â”€â”€ STATE â”€â”€â”€ */
let stage = 1, palette = 'purple';

const PAL = {
  purple:  ['#a78bfa','#c4b5fd','#ddd6fe','#ede9fe','#9575f5','#b39dff','#f5f3ff','#e9e4ff','#d8d0ff','#fdfcff','#f8f6ff','#f0edff'],
  sky:     ['#60a5fa','#93c5fd','#bfdbfe','#dbeafe','#4a8ee8','#7bb4f8','#f0f9ff','#e0f2fe','#d0e9ff','#fafcff','#f5f9ff','#ebf5ff'],
  emerald: ['#34d399','#6ee7b7','#a7f3d0','#d1fae5','#2bc589','#4fdb9f','#ecfdf5','#d8f8ed','#c2f4e0','#f5fef9','#effcf6','#e4f9f0'],
  pink:    ['#f472b6','#f9a8d4','#fbbcea','#fce7f3','#e85ca8','#f78bc2','#fdf2f8','#fce7f3','#fbd5e9','#fef9fc','#fef5f9','#fdf0f5'],
  amber:   ['#fbbf24','#fcd34d','#fde68a','#fef3c7','#eaa91c','#fcc740','#fefce8','#fef9e0','#fef5d0','#fffef5','#fffdf0','#fffae6'],
  orange:  ['#fb923c','#fdba74','#fed7aa','#ffedd5','#f27a28','#fda556','#fff7ed','#ffeddc','#ffe4ca','#fffcfa','#fffaf5','#fff6f0'],
};

window.addEventListener('DOMContentLoaded', updateCellCount);

function selectSwatch(el){
  document.querySelectorAll('.swatch').forEach(s=>s.classList.remove('selected'));
  el.classList.add('selected'); palette=el.dataset.color;
  if(document.getElementById('pattern-grid').classList.contains('visible')) renderCells();
}
function selectTag(el){
  el.closest('.tag-pills').querySelectorAll('.tag-pill').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
}
function updatePattern(){
  if(document.getElementById('pattern-grid').classList.contains('visible')) renderCells();
  updateCellCount();
}
function updateCellCount(){
  const c=+document.getElementById('range-cols').value, r=+document.getElementById('range-rows').value;
  const el=document.getElementById('cell-count'); if(el) el.textContent=(c*r)+' cells';
}
function toggleWM(cb){ const w=document.getElementById('paper-watermark'); if(w) w.style.display=cb.checked?'block':'none'; }

function generatePattern(){
  document.getElementById('canvas-empty').style.display='none';
  renderCells();
  document.getElementById('pattern-grid').classList.add('visible');
}
function renderCells(){
  const cols=+document.getElementById('range-cols').value;
  const rows=+document.getElementById('range-rows').value;
  const gap=+document.getElementById('range-gap').value;
  const nums=document.getElementById('toggle-num').checked;
  const lbl=document.getElementById('toggle-labels').checked;
  const pal=PAL[palette]||PAL.purple;
  const g=document.getElementById('pattern-grid');
  g.style.setProperty('--cols',cols); g.style.setProperty('--rows',rows);
  g.style.gap=gap+'px'; g.innerHTML='';
  for(let i=0,t=cols*rows;i<t;i++){
    const c=document.createElement('div');
    c.className='pattern-cell';
    c.style.background=rgba(pal[i%pal.length],0.15);
    c.style.borderColor=rgba(pal[i%pal.length],0.38);
    c.style.animationDelay=(i*0.028)+'s';
    if(nums||lbl){ c.textContent=String.fromCharCode(65+(i%cols))+(Math.floor(i/cols)+1); c.style.color=rgba(pal[i%pal.length],0.75); }
    c.addEventListener('click',()=>{ document.querySelectorAll('.pattern-cell').forEach(x=>x.classList.remove('active-cell')); c.classList.add('active-cell'); });
    g.appendChild(c);
  }
  updateCellCount();
}
function rgba(h,a){ const r=parseInt(h.slice(1,3),16),gr=parseInt(h.slice(3,5),16),b=parseInt(h.slice(5,7),16); return `rgba(${r},${gr},${b},${a})`; }

/* Stage machine */
function goTo(n){
  const from=document.getElementById('stage-'+stage), to=document.getElementById('stage-'+n);
  from.classList.remove('active'); from.classList.add('exit');
  setTimeout(()=>from.classList.remove('exit'),500);
  to.classList.add('active'); stage=n; updatePills(); updateLabel();
}
function updatePills(){
  for(let i=1;i<=3;i++){
    const p=document.getElementById('pill-'+i);
    p.classList.remove('active','done');
    if(i<stage) p.classList.add('done');
    if(i===stage) p.classList.add('active');
  }
}
function updateLabel(){
  const n=['Pattern Builder','Processing','Output Ready'];
  document.getElementById('sn').textContent=stage;
  document.getElementById('ss').textContent=n[stage-1];
}

/* Processing */
const SCHED=[{s:420,e:1100},{s:1200,e:2200},{s:2300,e:3600},{s:3700,e:5100},{s:5200,e:7200}];
const LOGS=[
  {t:80,  tp:'i',m:'workspace.init() â†’ OK'},
  {t:430, tp:'o',m:'config loaded â€” cells, palette: '+palette},
  {t:920, tp:'i',m:'grid.build(cols=4, rows=3, gap=8)'},
  {t:1310,tp:'o',m:'cell bounds computed â€” aspect 1:0.75'},
  {t:1900,tp:'i',m:'pattern.apply(type="geometric", density="regular")'},
  {t:2450,tp:'o',m:'transformations applied'},
  {t:3000,tp:'w',m:'symmetry disabled â€” skipping mirror pass'},
  {t:3800,tp:'i',m:'colour.calibrate(palette="'+palette+'")'},
  {t:4500,tp:'o',m:'contrast ratio 4.9:1 â€” WCAG AA âœ“'},
  {t:5300,tp:'i',m:'paper.compose() â†’ writing PDF manifest'},
  {t:6500,tp:'o',m:'export ready â€” 1.2 MB Â· PDF Â· 300 dpi'},
];
const SUBS=['Initialising workspaceâ€¦','Building grid structureâ€¦','Applying pattern rulesâ€¦','Calibrating coloursâ€¦','Composing paperâ€¦'];
const DURS=['0.7s','1.0s','1.3s','1.4s','2.0s'];

function goToStage2(){ generatePattern(); goTo(2); runProc(); }

function runProc(){
  for(let i=0;i<5;i++){
    const el=document.getElementById('step-'+i);
    el.classList.remove('done','running','revealed');
    document.getElementById('si-'+i).textContent=i+1;
    document.getElementById('st-'+i).textContent='â€”';
  }
  setP(0);
  document.getElementById('log-terminal').querySelectorAll('.log-entry').forEach(e=>e.remove());
  document.getElementById('proc-title').textContent='Generating Pattern';
  document.getElementById('proc-sub').textContent='Initialising render pipelineâ€¦';
  document.getElementById('proc-badge').textContent='Running';
  document.getElementById('proc-badge').className='badge badge-amber';
  const core=document.getElementById('proc-core');
  core.style.animation=''; core.style.background=''; core.style.borderRadius='';

  for(let i=0;i<5;i++) setTimeout(()=>document.getElementById('step-'+i).classList.add('revealed'),i*70);

  SCHED.forEach((s,i)=>{
    setTimeout(()=>{
      if(i>0) doneStep(i-1);
      document.getElementById('step-'+i).classList.add('running');
      document.getElementById('proc-sub').textContent=SUBS[i];
      setP(Math.round((i/5)*100));
    },s.s);
  });

  setTimeout(()=>{
    doneStep(4); setP(100);
    document.getElementById('proc-title').textContent='Pattern Generated';
    document.getElementById('proc-sub').textContent='All steps complete â€” output ready!';
    document.getElementById('proc-badge').textContent='âœ“ Done';
    document.getElementById('proc-badge').className='badge badge-green';
    const c=document.getElementById('proc-core');
    c.style.animation='none'; c.style.background='var(--green)'; c.style.borderRadius='50%';
    setTimeout(buildPaper,300);
    setTimeout(()=>goTo(3),900);
  },7600);

  LOGS.forEach(l=>setTimeout(()=>addLog(l.tp,l.m),l.t));
}

function doneStep(i){
  const el=document.getElementById('step-'+i);
  el.classList.remove('running'); el.classList.add('done');
  document.getElementById('si-'+i).innerHTML=`<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>`;
  document.getElementById('st-'+i).textContent=DURS[i];
}
function setP(v){
  document.getElementById('prog-fill').style.width=v+'%';
  document.getElementById('prog-pct').textContent=v+'%';
}
function addLog(tp,msg){
  const term=document.getElementById('log-terminal');
  const ts=new Date().toTimeString().slice(0,8);
  const d=document.createElement('div'); d.className='log-entry';
  const cls={i:'li',w:'lw',o:'lo'}[tp], lbl={i:'INFO',w:'WARN',o:'  OK'}[tp];
  d.innerHTML=`<span class="lt">${ts}</span><span class="${cls}">${lbl}</span>${msg.replace(/&/g,'&amp;').replace(/</g,'&lt;')}`;
  term.appendChild(d); term.scrollTop=term.scrollHeight;
}

function buildPaper(){
  const cols=+document.getElementById('range-cols').value;
  const rows=+document.getElementById('range-rows').value;
  const gap=document.getElementById('range-gap').value;
  const pal=PAL[palette]||PAL.purple;
  const title=document.getElementById('doc-title').value||'Untitled';
  const wm=document.getElementById('toggle-watermark').checked;

  const dt=document.getElementById('paper-doc-title');
  if(dt) dt.querySelector('span').textContent=title;

  const pv=document.getElementById('paper-pattern-visual');
  if(pv){
    pv.style.gridTemplateColumns=`repeat(${cols},1fr)`;
    pv.innerHTML='';
    for(let i=0,t=cols*rows;i<t;i++){
      const c=document.createElement('div');
      c.className='paper-pattern-cell';
      c.style.background=rgba(pal[i%pal.length],0.22);
      c.style.borderColor=rgba(pal[i%pal.length],0.38);
      c.style.color=rgba(pal[i%pal.length],0.82);
      c.textContent=String.fromCharCode(65+(i%cols))+(Math.floor(i/cols)+1);
      c.style.animationDelay=(i*0.04)+'s';
      pv.appendChild(c);
    }
  }
  const cfg=document.getElementById('paper-cfg');
  if(cfg) cfg.textContent=`Grid: ${cols} col Ã— ${rows} row Â· Spacing: ${gap}px Â· Type: Geometric Â· Density: Regular Â· Symmetry: None Â· Palette: ${palette.charAt(0).toUpperCase()+palette.slice(1)} Â· Watermark: ${wm?'On':'Off'}`;
}

function resetToStage1(){
  document.getElementById('pattern-grid').classList.remove('visible');
  document.getElementById('pattern-grid').innerHTML='';
  document.getElementById('canvas-empty').style.display='flex';
  if(stage!==1) goTo(1); else { updatePills(); updateLabel(); }
}
</script>
</body>
</html>